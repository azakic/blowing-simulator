<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Length Report - Blowing Simulator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .back-link {
            color: #007bff;
            text-decoration: none;
            font-size: 16px;
            margin-bottom: 20px;
            display: inline-block;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .filter-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .filter-row {
            display: flex;
            gap: 20px;
            align-items: end;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }
        .filter-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #495057;
        }
        .filter-group input[type="date"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .checkbox-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        .checkbox-item label {
            font-weight: 500;
            cursor: pointer;
        }
        .fremco-label {
            color: #155724;
        }
        .jetting-label {
            color: #004085;
        }
        .filter-buttons {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .summary-card h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            opacity: 0.9;
        }
        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }
        .summary-card .unit {
            font-size: 14px;
            opacity: 0.8;
        }
        .report-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            font-size: 15px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(44,62,80,0.07);
        }
        .report-table th {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 18px 12px;
            text-align: left;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 2;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        .report-table td {
            padding: 14px 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        .report-table tr:hover {
            background-color: #f3f0fa;
            transition: background 0.2s;
        }
        .report-table tr:nth-child(even) {
            background-color: #f8f8fc;
        }
        .report-table tr:nth-child(even):hover {
            background-color: #e7e3f3;
        }
        .protocol-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .protocol-type.fremco {
            background: #d4edda;
            color: #155724;
        }
        .protocol-type.jetting {
            background: #cce7ff;
            color: #004085;
        }
        .numeric-value {
            font-family: 'Consolas', 'Monaco', monospace;
            font-weight: 500;
            text-align: right;
        }
        .null-value {
            color: #adb5bd;
            font-style: italic;
            font-size: 12px;
        }
        .filename {
            font-family: monospace;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .export-options {
            margin-bottom: 20px;
            text-align: right;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
        }
        .view-btn {
            background: #17a2b8;
            color: white;
            text-decoration: none;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
        }
        .view-btn:hover {
            background: #138496;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/protocols" class="back-link">← Back to Protocols</a>
        
        <h1>Length Report by Date</h1>
        
        <form class="filter-form" method="GET">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="start_date">Start Date:</label>
                    <input type="date" name="start_date" id="start_date" value="{{.StartDate}}">
                </div>
                <div class="filter-group">
                    <label for="end_date">End Date:</label>
                    <input type="date" name="end_date" id="end_date" value="{{.EndDate}}">
                </div>
                <div class="filter-group">
                    <label>Protocol Types:</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" name="fremco" id="fremco" {{if .IncludeFremco}}checked{{end}}>
                            <label for="fremco" class="fremco-label">Fremco</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="jetting" id="jetting" {{if .IncludeJetting}}checked{{end}}>
                            <label for="jetting" class="jetting-label">Jetting</label>
                        </div>
                    </div>
                </div>
                <div class="filter-buttons">
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                    <a href="/protocols/length-report" class="btn btn-secondary">Clear All</a>
                </div>
            </div>
        </form>
        
        {{if .Reports}}
        <div class="summary-cards">
            <div class="summary-card">
                <h3>Total Protocols</h3>
                <div class="value">{{.TotalProtocols}}</div>
            </div>
            <div class="summary-card">
                <h3>Total Length</h3>
                <div class="value">{{printf "%.1f" .TotalMeasurements}}</div>
                <div class="unit">meters</div>
            </div>
            <div class="summary-card">
                <h3>Max Length</h3>
                <div class="value">{{printf "%.1f" .MaxLengthOverall}}</div>
                <div class="unit">meters</div>
            </div>
            <div class="summary-card">
                <h3>Average Length</h3>
                <div class="value">{{printf "%.1f" .OverallAverage}}</div>
                <div class="unit">meters</div>
            </div>
        </div>
        
        <div class="export-options">
            <button class="btn btn-success" onclick="exportToCSV()">Export CSV</button>
        </div>
        
        <table class="report-table" id="reportTable">
            <thead>
                <tr>
                    <th onclick="sortTable(0)" style="cursor: pointer;">Date ▲▼</th>
                    <th onclick="sortTable(1)" style="cursor: pointer;">Type ▲▼</th>
                    <th onclick="sortTable(2)" style="cursor: pointer;">Company ▲▼</th>
                    <th onclick="sortTable(3)" style="cursor: pointer;">Service Provider ▲▼</th>
                    <th onclick="sortTable(4)" style="cursor: pointer;">Max Length (m) ▲▼</th>
                    <th onclick="sortTable(5)" style="cursor: pointer;">NVT Number ▲▼</th>
                    <th onclick="sortTable(6)" style="cursor: pointer;">Filename ▲▼</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {{range .Reports}}
                <tr>
                    <td>{{if .ProtocolDate.Valid}}{{dateFormat .ProtocolDate.String}}{{else}}<span class="null-value">N/A</span>{{end}}</td>
                    <td><span class="protocol-type {{.ProtocolType}}">{{.ProtocolType}}</span></td>
                    <td>{{if .Company.Valid}}{{.Company.String}}{{else}}<span class="null-value">N/A</span>{{end}}</td>
                    <td>{{if .ServiceProvider.Valid}}{{.ServiceProvider.String}}{{else}}<span class="null-value">N/A</span>{{end}}</td>
                    <td class="numeric-value">{{if .MaxLength.Valid}}{{printf "%.1f" .MaxLength.Float64}}{{else}}<span class="null-value">—</span>{{end}}</td>
                    <td>{{extractNVT .SourceFilename.String}}</td>
                    <td>{{if .SourceFilename.Valid}}<span class="filename">{{.SourceFilename.String}}</span>{{else}}<span class="null-value">N/A</span>{{end}}</td>
                    <td>
                        <a href="/protocols/view?id={{.ProtocolID}}" class="view-btn">View</a>
                        {{if gt .MeasurementCount 0}}
                        <a href="/protocols/measurements?id={{.ProtocolID}}" class="view-btn">Data</a>
                        {{end}}
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
        
        {{else}}
        <div class="no-data">
            <h3>No data found</h3>
            <p>{{if or .StartDate .EndDate}}Try adjusting your date range or format filters{{else}}No protocols match your criteria{{end}}</p>
        </div>
        {{end}}
    </div>

    <script>
        let sortDirection = {}; // Track sort direction for each column
        
        function sortTable(columnIndex) {
            const table = document.getElementById('reportTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Determine sort direction
            const isAscending = sortDirection[columnIndex] !== true;
            sortDirection[columnIndex] = isAscending;
            
            // Sort rows
            rows.sort((a, b) => {
                const cellA = a.cells[columnIndex];
                const cellB = b.cells[columnIndex];
                
                let valueA = cellA.textContent.trim();
                let valueB = cellB.textContent.trim();
                
                // Handle numeric columns (Min/Max/Avg Length, Measurements)
                if (columnIndex >= 4 && columnIndex <= 7) {
                    // Extract numeric values
                    const numA = parseFloat(valueA.replace(/[^0-9.-]/g, '')) || 0;
                    const numB = parseFloat(valueB.replace(/[^0-9.-]/g, '')) || 0;
                    return isAscending ? numA - numB : numB - numA;
                }
                
                // Handle date column
                if (columnIndex === 0) {
                    const dateA = valueA === 'N/A' ? new Date(0) : new Date(valueA.replace(/T.*$/, ''));
                    const dateB = valueB === 'N/A' ? new Date(0) : new Date(valueB.replace(/T.*$/, ''));
                    return isAscending ? dateA - dateB : dateB - dateA;
                }
                
                // Handle text columns
                const comparison = valueA.localeCompare(valueB);
                return isAscending ? comparison : -comparison;
            });
            
            // Clear tbody and add sorted rows
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
            
            // Update header indicators
            updateSortIndicators(columnIndex, isAscending);
        }
        
        function updateSortIndicators(activeColumn, isAscending) {
            const headers = document.querySelectorAll('#reportTable th[onclick]');
            headers.forEach((header, index) => {
                const text = header.textContent.replace(/ [▲▼]+$/, '');
                if (index === activeColumn) {
                    header.textContent = text + (isAscending ? ' ▲' : ' ▼');
                } else {
                    header.textContent = text + ' ▲▼';
                }
            });
        }
        
        function exportToCSV() {
            // Get date range from form inputs
            const startDate = document.getElementById('start_date').value || 'All dates';
            const endDate = document.getElementById('end_date').value || 'All dates';
            
            // Create CSV header with only table columns
            let csvContent = 'Date\tAddress\tNVT Number\tMax Length (m)\n';
            
            // Get table data rows (skip header)
            const table = document.getElementById('reportTable');
            const dataRows = Array.from(table.querySelectorAll('tbody tr'));
            
            // Create array of data for sorting by date
            const reportData = dataRows.map(row => {
                const cols = row.querySelectorAll('td');
                const date = cols[0].textContent.trim();
                const filename = cols[8].textContent.trim();
                const maxLength = cols[5].textContent.trim();
                
                // Extract address from filename
                let address = 'N/A';
                if (filename && filename !== 'N/A') {
                    // For Jetting format: "29.10.2025, 11 09, Eiemarkt 14 NVT 1V2200.pdf"
                    if (filename.includes(',')) {
                        const parts = filename.split(',');
                        if (parts.length >= 3) {
                            const addressPart = parts[2].trim();
                            // Remove NVT part from address
                            address = addressPart.replace(/\\s+NVT\\s+\\w+.*$/i, '').trim();
                        }
                    }
                    // For Fremco format: extract from filename if needed
                    else if (filename.includes('_')) {
                        const parts = filename.split('_');
                        // Look for address parts (skip project, date, time parts)
                        if (parts.length > 4) {
                            const addressParts = [];
                            for (let i = 3; i < parts.length; i++) {
                                if (parts[i].startsWith('NVT')) break;
                                addressParts.push(parts[i]);
                            }
                            address = addressParts.join(' ').replace(/\\.pdf$/i, '');
                        }
                    }
                }
                
                return {
                    date: date,
                    address: address,
                    maxLength: maxLength,
                    sortDate: new Date(date.replace(/T.*$/, '')) // For sorting
                };
            });
            
            // Sort by date ascending, then by address alphabetically within each date
            reportData.sort((a, b) => {
                // First sort by date
                const dateComparison = a.sortDate - b.sortDate;
                if (dateComparison !== 0) {
                    return dateComparison;
                }
                // If dates are the same, sort by address alphabetically
                return a.address.localeCompare(b.address);
            });
            
            // Add sorted data to CSV
            let totalMaxLength = 0;
            reportData.forEach(row => {
                let formattedDate = row.date;
                if (row.date !== 'N/A' && row.sortDate && !isNaN(row.sortDate)) {
                    // Format date as DD.MM.YYYY
                    const day = String(row.sortDate.getDate()).padStart(2, '0');
                    const month = String(row.sortDate.getMonth() + 1).padStart(2, '0');
                    const year = row.sortDate.getFullYear();
                    formattedDate = day + '.' + month + '.' + year;
                }
                // Extract NVT number from filename
                let nvt = '';
                if (filename && filename !== 'N/A') {
                    const nvtMatch = filename.match(/(NVT\s*\w+)/i);
                    if (nvtMatch) {
                        nvt = nvtMatch[1];
                    }
                }
                csvContent += formattedDate + '\t' + row.address.replace(/"/g, '""') + '\t' + nvt + '\t' + row.maxLength + '\n';
                
                // Sum up max lengths (parse numeric value, ignore non-numeric)
                const numericLength = parseFloat(row.maxLength.replace(/[^0-9.]/g, ''));
                if (!isNaN(numericLength)) {
                    totalMaxLength += numericLength;
                }
            });
            
            // Add summary row
            csvContent += 'Total\tSum\t\t' + totalMaxLength.toFixed(1) + '\n';
            csvContent += 'Total\tSum of Max Lengths\t\t' + totalMaxLength.toFixed(1) + '\n';
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'length-report-by-date-' + new Date().toISOString().split('T')[0] + '.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Set default dates if none provided
        document.addEventListener('DOMContentLoaded', function() {
            const startDate = document.getElementById('start_date');
            const endDate = document.getElementById('end_date');
            
            if (!startDate.value) {
                // Default to 30 days ago
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                startDate.value = thirtyDaysAgo.toISOString().split('T')[0];
            }
            
            if (!endDate.value) {
                // Default to today
                endDate.value = new Date().toISOString().split('T')[0];
            }
        });
    </script>
    
    <style>
        .report-table th[onclick] {
            background-color: #f8f9fa;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        .report-table th[onclick]:hover {
            background-color: #e9ecef;
        }
        
        .report-table th[onclick]:active {
            background-color: #dee2e6;
        }
    </style>
</body>
</html>
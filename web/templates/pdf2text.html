<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>PDF to Text Converter</title>
        <link rel="stylesheet" href="/static/style.css" />
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 2em;
                background: #f9f9f9;
            }
            h1 {
                color: #333;
            }
            form {
                background: #fff;
                padding: 1.5em;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                max-width: 500px;
                margin-bottom: 2em;
            }
            label {
                display: block;
                margin-top: 1em;
            }
            input[type="file"],
            select,
            button {
                margin-top: 0.5em;
            }
            button {
                padding: 0.5em 1.5em;
                background: #007bff;
                color: #fff;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            button:hover {
                background: #0056b3;
            }
            pre {
                background: #222;
                color: #eee;
                padding: 1em;
                border-radius: 8px;
                overflow-x: auto;
            }
            .result {
                margin-top: 2em;
            }
            table {
                border-collapse: collapse;
                width: 100%;
                margin-bottom: 2em;
            }
            th,
            td {
                border: 1px solid #333;
                padding: 6px 12px;
                text-align: center;
            }
            th {
                background: #eee;
            }
        </style>
    </head>
    <body>
        <h1>PDF to Text Converter</h1>
        <div class="result">
            <h2>Report Info</h2>
            <table>
                <tr><th>Project Number</th><td>{{ .Project }}</td></tr>
                <tr><th>Filename</th><td>{{ .Filename }}</td></tr>
                <tr><th>Date</th><td>{{ .Date }}</td></tr>
                <tr><th>Time (hh.mm)</th><td>{{ formatTime .Time }}</td></tr>
                <tr><th>Address</th><td>{{ .Address }}</td></tr>
                <tr><th>NVT</th><td>{{ .NVT }}</td></tr>
            </table>
        </div>
        {{ if .FremcoMeta }}
        <div class="result">
            <h2>Fremco Metadata</h2>
            <table>
                <tbody>
                {{ range $key, $val := .FremcoMeta }}
                    <tr><th>{{ $key }}</th><td>{{ $val }}</td></tr>
                {{ end }}
                </tbody>
            </table>
        </div>
        {{ end }}
        <form action="/pdf2text" method="post" enctype="multipart/form-data">
            <label for="pdfFile">Select PDF file:</label>
            <input
                type="file"
                id="pdfFile"
                name="pdfFile"
                accept="application/pdf"
                required
            />
            <button type="submit">Convert to Text</button>
        </form>
        <div class="result">
            <h2>Messwerte Tabelle</h2>
            <table id="measurements-table">
                <thead>
                    <tr>
                        <th>Länge[m]</th>
                        <th>Lufttemperatur[°C]</th>
                        <th>Schubkraft[N]</th>
                        <th>Einblasdruck[bar]</th>
                        <th>Geschwindigkeit[m/min]</th>
                        <th>Zeit - Dauer[hh:mm:ss]</th>
                    </tr>
                </thead>
                <tbody id="measurements-tbody"></tbody>
            </table>
            <div id="no-measurements" style="display:none;color:#b00;font-weight:bold;display:none;">No measurement data found.</div>
        </div>
        <div class="result">
            <h2>Messwerte Chart</h2>
            <canvas id="measurements-chart" width="800" height="300"></canvas>
            <div id="no-chart" style="display:none;color:#b00;font-weight:bold;">No chart data available.</div>
        </div>
        <div class="result">
            <h2>JSON Report</h2>
            <pre id="json-output">{{ .JSON }}</pre>
            <button onclick="downloadJSON()">Download JSON</button>
            <div id="no-json" style="display:none;color:#b00;font-weight:bold;">No JSON data available.</div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
        function downloadJSON() {
            var data = document.getElementById("json-output").textContent;
            var blob = new Blob([data], { type: "application/json" });
            var url = URL.createObjectURL(blob);
            var a = document.createElement("a");
            a.href = url;
            a.download = "report.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Parse JSON from the pre block
        let measurements = [];
        try {
            measurements = JSON.parse(document.getElementById("json-output").textContent);
        } catch (e) {}

        // Render table
        const tbody = document.getElementById("measurements-tbody");
        if (measurements && measurements.length > 0) {
            // Check if this is Jetting format (has German field names) or Fremco format (has English field names)
            const isJetting = measurements[0] && measurements[0].hasOwnProperty('länge_m');
            
            if (isJetting) {
                // Jetting format with 6 columns
                measurements.forEach((m) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${(m.länge_m !== null && m.länge_m !== undefined) ? m.länge_m : ""}</td>
                        <td>${(m.lufttemperatur_c !== null && m.lufttemperatur_c !== undefined) ? m.lufttemperatur_c : ""}</td>
                        <td>${(m.schubkraft_n !== null && m.schubkraft_n !== undefined) ? m.schubkraft_n : ""}</td>
                        <td>${(m.einblasdruck_bar !== null && m.einblasdruck_bar !== undefined) ? m.einblasdruck_bar : ""}</td>
                        <td>${(m.geschwindigkeit_m_min !== null && m.geschwindigkeit_m_min !== undefined) ? m.geschwindigkeit_m_min : ""}</td>
                        <td>${m.zeit_dauer_hh_mm_ss || ""}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                // Fremco format with 5 columns (hide temperature column)
                measurements.forEach((m) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${(m.length !== null && m.length !== undefined) ? m.length : ""}</td>
                        <td style="display:none;"></td>
                        <td>${(m.torque !== null && m.torque !== undefined) ? m.torque : ""}</td>
                        <td>${(m.pressure !== null && m.pressure !== undefined) ? m.pressure : ""}</td>
                        <td>${(m.speed !== null && m.speed !== undefined) ? m.speed : ""}</td>
                        <td>${m.time || ""}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            document.getElementById("no-measurements").style.display = "none";
            
            // Update table headers based on format
            const thead = document.querySelector("#measurements-table thead tr");
            if (!isJetting) {
                // Hide temperature column for Fremco
                thead.children[1].style.display = "none";
            }
        } else {
            document.getElementById("no-measurements").style.display = "block";
        }

        // Prepare data for chart
        const isJettingData = measurements.length > 0 && measurements[0].hasOwnProperty('länge_m');
        const length = measurements.map((m) => isJettingData ? m.länge_m : m.length);
        const temperature = isJettingData ? measurements.map((m) => m.lufttemperatur_c) : [];
        const force = measurements.map((m) => isJettingData ? m.schubkraft_n : m.torque);
        const pressure = measurements.map((m) => isJettingData ? m.einblasdruck_bar : m.pressure);
        const speed = measurements.map((m) => isJettingData ? m.geschwindigkeit_m_min : m.speed);
        const ctx = document.getElementById("measurements-chart").getContext("2d");
        if (measurements && measurements.length > 0) {
            new Chart(ctx, {
                type: "line",
                data: {
                    labels: length,
                    datasets: isJettingData ? [
                        {
                            label: "Geschwindigkeit [m/min]",
                            data: speed,
                            borderColor: "green",
                            yAxisID: "y",
                            fill: false,
                        },
                        {
                            label: "Einblasdruck [bar]",
                            data: pressure,
                            borderColor: "blue",
                            yAxisID: "y1",
                            fill: false,
                        },
                        {
                            label: "Schubkraft [N]",
                            data: force,
                            borderColor: "red",
                            yAxisID: "y2",
                            fill: false,
                        },
                        {
                            label: "Lufttemperatur [°C]",
                            data: temperature,
                            borderColor: "orange",
                            yAxisID: "y3",
                            fill: false,
                        },
                    ] : [
                        {
                            label: "Geschwindigkeit [m/min]",
                            data: speed,
                            borderColor: "green",
                            yAxisID: "y",
                            fill: false,
                        },
                        {
                            label: "Rohr-Druck [bar]",
                            data: pressure,
                            borderColor: "blue",
                            yAxisID: "y1",
                            fill: false,
                        },
                        {
                            label: "Drehmoment [%]",
                            data: force,
                            borderColor: "red",
                            yAxisID: "y2",
                            fill: false,
                        },
                    ],
                },
                options: {
                    scales: {
                        x: {
                            title: { display: true, text: "Länge [m]" },
                            ticks: { maxTicksLimit: 12 },
                        },
                        y: {
                            type: "linear",
                            position: "left",
                            title: { display: true, text: "Geschwindigkeit [m/min]" },
                            max: 90,
                        },
                        y1: {
                            type: "linear",
                            position: "right",
                            title: { display: true, text: "Einblasdruck [bar]" },
                            grid: { drawOnChartArea: false },
                            max: 25,
                        },
                        y2: {
                            type: "linear",
                            position: "right",
                            title: { display: true, text: "Schubkraft [N]" },
                            grid: { drawOnChartArea: false },
                        },
                        y3: {
                            type: "linear",
                            position: "right",
                            title: { display: true, text: "Lufttemperatur [°C]" },
                            grid: { drawOnChartArea: false },
                            min: 10,
                            max: 20,
                        },
                    },
                },
            });
            document.getElementById("no-chart").style.display = "none";
        } else {
            document.getElementById("no-chart").style.display = "block";
        }

        // JSON fallback message
        const jsonBlock = document.getElementById("json-output");
        if (!measurements || measurements.length === 0 || jsonBlock.textContent.trim() === "[]") {
            document.getElementById("no-json").style.display = "block";
        } else {
            document.getElementById("no-json").style.display = "none";
        }
        </script>

        <div class="result">
            <h2>Extracted Text (Raw)</h2>
            <pre>{{ .Text }}</pre>
        </div>
        <div class="result">
            <h2>Normalized Text (for Jetting parser)</h2>
            <pre>{{ .Normalized }}</pre>
        </div>
    </body>
</html>

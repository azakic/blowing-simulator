<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>PDF to Text Converter</title>
        <link rel="stylesheet" href="/static/style.css" />
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 2em;
                background: #f9f9f9;
            }
            h1 {
                color: #333;
            }
            form {
                background: #fff;
                padding: 1.5em;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                max-width: 500px;
                margin-bottom: 2em;
            }
            label {
                display: block;
                margin-top: 1em;
            }
            input[type="file"],
            select,
            button {
                margin-top: 0.5em;
            }
            button {
                padding: 0.5em 1.5em;
                background: #007bff;
                color: #fff;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            button:hover {
                background: #0056b3;
            }
            pre {
                background: #222;
                color: #eee;
                padding: 1em;
                border-radius: 8px;
                overflow-x: auto;
            }
            .result {
                margin-top: 2em;
            }
            table {
                border-collapse: collapse;
                width: 100%;
                margin-bottom: 2em;
            }
            th,
            td {
                border: 1px solid #333;
                padding: 6px 12px;
                text-align: center;
            }
            th {
                background: #eee;
            }
        </style>
    </head>
    <body>
        <h1>PDF to Text Converter</h1>
        <form action="/pdf2text" method="post" enctype="multipart/form-data">
            <label for="pdfFile">Select PDF file:</label>
            <input
                type="file"
                id="pdfFile"
                name="pdfFile"
                accept="application/pdf"
                required
            />
            <button type="submit">Convert to Text</button>
        </form>
        <div class="result">
            <h2>Messwerte Tabelle</h2>
            <table id="measurements-table">
                <thead>
                    <tr>
                        <th>Streckenl√§nge [m]</th>
                        <th>Geschwindigkeit [m/min]</th>
                        <th>Rohr-Druck [bar]</th>
                        <th>Drehmoment [%]</th>
                        <th>Uhrzeit [hh:mm:ss]</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- JS will insert rows here -->
                </tbody>
            </table>
        </div>

        <div class="result">
            <h2>Messwerte Diagramm</h2>
            <canvas id="measurements-chart" width="900" height="400"></canvas>
        </div>

        <div class="result">
            <h2>Uniform JSON Output</h2>
            <button onclick="downloadJSON()">Download JSON</button>
            {{ if .JSON }}
            <pre id="json-output">{{ .JSON }}</pre>
            {{ else }}
            <pre id="json-output">[]</pre>
            {{ end }}
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            function downloadJSON() {
                var data = document.getElementById("json-output").textContent;
                var blob = new Blob([data], { type: "application/json" });
                var url = URL.createObjectURL(blob);
                var a = document.createElement("a");
                a.href = url;
                a.download = "report.json";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // Parse JSON from the pre block
            let measurements = [];
            try {
                measurements = JSON.parse(
                    document.getElementById("json-output").textContent,
                );
            } catch (e) {}

            // Render table
            const tbody = document
                .getElementById("measurements-table")
                .querySelector("tbody");
            if (measurements && measurements.length > 0) {
                measurements.forEach((m) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                <td>${m.length}</td>
                <td>${m.speed}</td>
                <td>${m.pressure}</td>
                <td>${m.torque}</td>
                <td>${m.datetime || ""}</td>
            `;
                    tbody.appendChild(row);
                });
            }

            // Prepare data for chart
            const length = measurements.map((m) => m.length);
            const speed = measurements.map((m) => m.speed);
            const pressure = measurements.map((m) => m.pressure);
            const torque = measurements.map((m) => m.torque);

            // Basic Chart.js axis: no custom tick logic

            const ctx = document
                .getElementById("measurements-chart")
                .getContext("2d");
            new Chart(ctx, {
                type: "line",
                data: {
                    labels: length,
                    datasets: [
                        {
                            label: "Geschwindigkeit [m/min]",
                            data: speed,
                            borderColor: "green",
                            yAxisID: "y",
                            fill: false,
                        },
                        {
                            label: "Rohr-Druck [bar]",
                            data: pressure,
                            borderColor: "blue",
                            yAxisID: "y1",
                            fill: false,
                        },
                        {
                            label: "Drehmoment [%]",
                            data: torque,
                            borderColor: "red",
                            yAxisID: "y2",
                            fill: false,
                        },
                    ],
                },
                options: {
                    scales: {
                        x: {
                            title: { display: true, text: "Strecke [m]" },
                            ticks: {
                                maxTicksLimit: 12,
                            },
                        },
                        y: {
                            type: "linear",
                            position: "left",
                            title: {
                                display: true,
                                text: "Geschwindigkeit [m/min]",
                            },
                            max: 90,
                        },
                        y1: {
                            type: "linear",
                            position: "right",
                            title: { display: true, text: "Rohr-Druck [bar]" },
                            grid: { drawOnChartArea: false },
                            max: 25,
                        },
                        y2: {
                            type: "linear",
                            position: "right",
                            title: { display: true, text: "Drehmoment [%]" },
                            grid: { drawOnChartArea: false },
                        },
                    },
                },
            });
        </script>

        {{ if .Text }}
        <div class="result">
            <h2>Extracted Text</h2>
            <pre>{{ .Text }}</pre>
        </div>
        {{ end }}
    </body>
</html>
